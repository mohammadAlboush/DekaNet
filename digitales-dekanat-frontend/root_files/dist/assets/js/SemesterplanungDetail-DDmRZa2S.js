import{j as e,B as k,z as $,N as P,f as s,I as M,bj as V,ab as y,$ as t,P as u,K as x,aY as U,ae as Y,af as q,ag as J,ah as D,ai as a,aj as Q,b3 as X,ak as Z,al as ee,a4 as ne,am as re,aD as se,aE as ae,aF as te,aw as ie,ax as le,az as ce,o as oe,O as f,aH as de}from"./vendor-mui-BiVZR0IW.js";import{i as ue,u as he,r as h}from"./vendor-react-CBtCGaWm.js";import{p as j}from"./planungService-CoVGOVAB.js";import{m as xe}from"./modulService-OIZms_eT.js";import{u as ge,b as me,c as je}from"./index-ChymPdOX.js";import"./vendor-utils-DTv3oRQQ.js";const I=je("SemesterplanungDetail"),ye=()=>{const{id:o}=ue(),z=he(),{user:i}=ge(),l=me(n=>n.showToast),[A,E]=h.useState(!0),[r,W]=h.useState(null),[C,F]=h.useState([]),[T,v]=h.useState(!1),[_,S]=h.useState(null),[c,g]=h.useState({anzahl_vorlesungen:1,anzahl_uebungen:1,anzahl_praktika:0,anzahl_seminare:0,bemerkung:""}),m=window.location.pathname.includes("/edit"),w=()=>i?.rolle?typeof i.rolle=="string"?i.rolle:i.rolle.name:null,p=r?.status==="entwurf"&&(i?.id===r?.benutzer_id||w()==="dekan");h.useEffect(()=>{r&&i&&I.debug(" Berechtigungen:",{isEdit:m,canEdit:p,planung_status:r.status,user_id:i.id,planung_benutzer_id:r.benutzer_id,user_rolle:w(),isOwner:i.id===r.benutzer_id,isDekan:w()==="dekan"})},[r,i,m,p]),h.useEffect(()=>{o&&(b(),B())},[o]);const b=async()=>{try{const n=await j.getPlanung(parseInt(o));n.success&&W(n.data)}catch{l("Fehler beim Laden der Planung","error")}finally{E(!1)}},B=async()=>{try{const n=await xe.getAllModules();n.success&&F(n.data||[])}catch(n){I.error("Error loading modules:",n)}},L=async()=>{if(!(!_||!r))try{(await j.addModule(parseInt(o),{modul_id:_.id,po_id:r.po_id,...c})).success&&(l("Modul hinzugefügt","success"),b(),v(!1),K())}catch{l("Fehler beim Hinzufügen des Moduls","error")}},O=async n=>{if(confirm("Modul wirklich entfernen?"))try{(await j.removeModule(parseInt(o),n)).success&&(l("Modul entfernt","success"),b())}catch{l("Fehler beim Entfernen des Moduls","error")}},R=async()=>{if(confirm("Planung wirklich einreichen? Nach dem Einreichen können keine Änderungen mehr vorgenommen werden."))try{(await j.submitPlanung(parseInt(o))).success&&(l("Planung erfolgreich eingereicht","success"),z("/semesterplanung"))}catch{l("Fehler beim Einreichen der Planung","error")}},G=async()=>{try{(await j.approvePlanung(parseInt(o))).success&&(l("Planung freigegeben","success"),b())}catch{l("Fehler beim Freigeben der Planung","error")}},H=async()=>{const n=prompt("Ablehnungsgrund eingeben:");if(n)try{(await j.rejectPlanung(parseInt(o),n)).success&&(l("Planung abgelehnt","success"),b())}catch{l("Fehler beim Ablehnen der Planung","error")}},K=()=>{S(null),g({anzahl_vorlesungen:1,anzahl_uebungen:1,anzahl_praktika:0,anzahl_seminare:0,bemerkung:""})};return A?e.jsx(k,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx($,{})}):r?e.jsxs(P,{maxWidth:"xl",children:[e.jsxs(k,{sx:{mb:3,display:"flex",alignItems:"center",gap:2},children:[e.jsx(M,{onClick:()=>z("/semesterplanung"),children:e.jsx(V,{})}),e.jsxs(s,{variant:"h4",sx:{flex:1},children:["Semesterplanung ",r.semester?.kuerzel]}),e.jsx(y,{label:r.status,color:r.status==="freigegeben"?"success":r.status==="eingereicht"?"warning":r.status==="abgelehnt"?"error":"default"})]}),e.jsxs(t,{container:!0,spacing:3,sx:{mb:3},children:[e.jsx(t,{item:!0,xs:12,md:3,children:e.jsxs(u,{sx:{p:2},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Dozent"}),e.jsx(s,{variant:"body1",children:r.benutzer?.name_komplett})]})}),e.jsx(t,{item:!0,xs:12,md:2,children:e.jsxs(u,{sx:{p:2},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Module"}),e.jsx(s,{variant:"h6",children:r.geplante_module?.length||0})]})}),e.jsx(t,{item:!0,xs:12,md:2,children:e.jsxs(u,{sx:{p:2},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Gesamt SWS"}),e.jsx(s,{variant:"h6",children:r.gesamt_sws?.toFixed(1)||"0.0"})]})}),e.jsx(t,{item:!0,xs:12,md:2,children:e.jsxs(u,{sx:{p:2},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:"Gesamt ECTS"}),e.jsx(s,{variant:"h6",children:r.geplante_module?.reduce((n,d)=>n+(d.modul?.leistungspunkte||0),0)||0})]})}),e.jsx(t,{item:!0,xs:12,md:3,children:e.jsxs(u,{sx:{p:2},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",children:r.status==="eingereicht"?"Eingereicht am":r.status==="freigegeben"?"Freigegeben am":"Erstellt am"}),e.jsx(s,{variant:"body2",children:r.eingereicht_am?new Date(r.eingereicht_am).toLocaleDateString("de-DE"):r.freigegeben_am?new Date(r.freigegeben_am).toLocaleDateString("de-DE"):new Date(r.created_at).toLocaleDateString("de-DE")})]})})]}),(r.anmerkungen||r.wunsch_freie_tage?.length>0)&&e.jsxs(t,{container:!0,spacing:3,sx:{mb:3},children:[r.anmerkungen&&e.jsx(t,{item:!0,xs:12,md:6,children:e.jsxs(u,{sx:{p:2},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Anmerkungen zur Planung"}),e.jsx(s,{variant:"body2",sx:{whiteSpace:"pre-wrap"},children:r.anmerkungen})]})}),r.wunsch_freie_tage&&r.wunsch_freie_tage.length>0&&e.jsx(t,{item:!0,xs:12,md:6,children:e.jsxs(u,{sx:{p:2},children:[e.jsx(s,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"Wunsch-freie Tage"}),r.wunsch_freie_tage.map((n,d)=>e.jsx(y,{label:n.wochentag,size:"small",sx:{mr:1,mb:1}},d))]})})]}),e.jsxs(u,{sx:{mb:3},children:[e.jsxs(k,{sx:{p:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(s,{variant:"h6",children:"Geplante Module"}),p&&m&&e.jsx(x,{variant:"contained",startIcon:e.jsx(U,{}),onClick:()=>v(!0),children:"Modul hinzufügen"})]}),e.jsx(Y,{children:e.jsxs(q,{children:[e.jsx(J,{children:e.jsxs(D,{children:[e.jsx(a,{children:"Kürzel"}),e.jsx(a,{children:"Bezeichnung"}),e.jsx(a,{align:"center",children:"ECTS"}),e.jsx(a,{align:"center",children:"V"}),e.jsx(a,{align:"center",children:"Ü"}),e.jsx(a,{align:"center",children:"P"}),e.jsx(a,{align:"center",children:"S"}),e.jsx(a,{align:"right",children:"SWS"}),e.jsx(a,{children:"Mitarbeiter"}),e.jsx(a,{children:"Anmerkungen"}),p&&m&&e.jsx(a,{align:"center",children:"Aktionen"})]})}),e.jsx(Q,{children:r.geplante_module?.map(n=>e.jsxs(D,{children:[e.jsx(a,{children:e.jsx(s,{variant:"body2",fontWeight:600,children:n.modul?.kuerzel})}),e.jsx(a,{children:e.jsx(s,{variant:"body2",children:n.modul?.bezeichnung_de})}),e.jsx(a,{align:"center",children:e.jsx(y,{label:n.modul?.leistungspunkte||0,size:"small",variant:"outlined"})}),e.jsx(a,{align:"center",children:e.jsx(s,{variant:"body2",children:n.anzahl_vorlesungen||"-"})}),e.jsx(a,{align:"center",children:e.jsx(s,{variant:"body2",children:n.anzahl_uebungen||"-"})}),e.jsx(a,{align:"center",children:e.jsx(s,{variant:"body2",children:n.anzahl_praktika||"-"})}),e.jsx(a,{align:"center",children:e.jsx(s,{variant:"body2",children:n.anzahl_seminare||"-"})}),e.jsx(a,{align:"right",children:e.jsx(s,{variant:"body2",fontWeight:600,children:(n.sws_gesamt??0).toFixed(1)})}),e.jsx(a,{children:n.mitarbeiter_ids&&n.mitarbeiter_ids.length>0?e.jsx(y,{label:`${n.mitarbeiter_ids.length} Mitarbeiter`,size:"small",color:"primary"}):e.jsx(s,{variant:"caption",color:"text.secondary",children:"Keine"})}),e.jsx(a,{children:n.anmerkungen?e.jsx(s,{variant:"caption",sx:{display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",maxWidth:"200px"},children:n.anmerkungen}):e.jsx(s,{variant:"caption",color:"text.secondary",children:"-"})}),p&&m&&e.jsx(a,{align:"center",children:e.jsx(M,{size:"small",color:"error",onClick:()=>O(n.modul_id),children:e.jsx(X,{})})})]},n.id))})]})})]}),e.jsxs(k,{sx:{display:"flex",gap:2,justifyContent:"flex-end"},children:[r.status==="entwurf"&&i?.id===r.benutzer_id&&e.jsxs(e.Fragment,{children:[!m&&e.jsx(x,{variant:"outlined",startIcon:e.jsx(Z,{}),onClick:()=>z(`/semesterplanung/${o}/edit`),children:"Bearbeiten"}),e.jsx(x,{variant:"contained",startIcon:e.jsx(ee,{}),onClick:R,children:"Einreichen"})]}),r.status==="eingereicht"&&i?.rolle==="dekan"&&e.jsxs(e.Fragment,{children:[e.jsx(x,{variant:"contained",color:"success",startIcon:e.jsx(ne,{}),onClick:G,children:"Freigeben"}),e.jsx(x,{variant:"outlined",color:"error",startIcon:e.jsx(re,{}),onClick:H,children:"Ablehnen"})]})]}),e.jsxs(se,{open:T,onClose:()=>v(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(ae,{children:"Modul hinzufügen"}),e.jsxs(te,{children:[e.jsxs(ie,{fullWidth:!0,sx:{mt:2,mb:2},children:[e.jsx(le,{children:"Modul auswählen"}),e.jsx(ce,{value:_?.id||"",onChange:n=>{const d=C.find(N=>N.id===n.target.value);S(d)},label:"Modul auswählen",children:C.map(n=>e.jsxs(oe,{value:n.id,children:[n.kuerzel," - ",n.bezeichnung_de]},n.id))})]}),e.jsxs(t,{container:!0,spacing:2,children:[e.jsx(t,{item:!0,xs:6,children:e.jsx(f,{fullWidth:!0,type:"number",label:"Anzahl Vorlesungen",value:c.anzahl_vorlesungen,onChange:n=>g({...c,anzahl_vorlesungen:parseInt(n.target.value)||0}),inputProps:{min:0,max:10}})}),e.jsx(t,{item:!0,xs:6,children:e.jsx(f,{fullWidth:!0,type:"number",label:"Anzahl Übungen",value:c.anzahl_uebungen,onChange:n=>g({...c,anzahl_uebungen:parseInt(n.target.value)||0}),inputProps:{min:0,max:10}})}),e.jsx(t,{item:!0,xs:6,children:e.jsx(f,{fullWidth:!0,type:"number",label:"Anzahl Praktika",value:c.anzahl_praktika,onChange:n=>g({...c,anzahl_praktika:parseInt(n.target.value)||0}),inputProps:{min:0,max:10}})}),e.jsx(t,{item:!0,xs:6,children:e.jsx(f,{fullWidth:!0,type:"number",label:"Anzahl Seminare",value:c.anzahl_seminare,onChange:n=>g({...c,anzahl_seminare:parseInt(n.target.value)||0}),inputProps:{min:0,max:10}})}),e.jsx(t,{item:!0,xs:12,children:e.jsx(f,{fullWidth:!0,multiline:!0,rows:2,label:"Bemerkung (optional)",value:c.bemerkung,onChange:n=>g({...c,bemerkung:n.target.value})})})]})]}),e.jsxs(de,{children:[e.jsx(x,{onClick:()=>v(!1),children:"Abbrechen"}),e.jsx(x,{variant:"contained",onClick:L,disabled:!_,children:"Hinzufügen"})]})]})]}):e.jsx(P,{children:e.jsx(s,{children:"Planung nicht gefunden"})})};export{ye as default};
