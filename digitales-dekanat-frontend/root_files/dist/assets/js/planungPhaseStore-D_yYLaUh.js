import{a6 as h}from"./vendor-utils-DTv3oRQQ.js";import{p as d,c as g,h as o}from"./index-ChymPdOX.js";import{p as t}from"./planungPhaseService-9n5IcayC.js";const c=g("PlanungPhaseStore"),u={activePhase:null,allPhases:[],submissionStatus:null,archivedPlanungen:[],phaseHistory:[],currentPhaseStatistics:null,phaseSubmissions:[],loading:!1,error:null},w=h()(d((e,i)=>({...u,isPhaseActive:()=>{const r=i();return r.activePhase!==null&&r.activePhase.ist_aktiv},canSubmit:()=>i().submissionStatus?.kann_einreichen===!0,getTimeRemaining:()=>{const r=i();if(!r.activePhase?.enddatum)return null;const a=new Date(r.activePhase.enddatum),n=new Date,s=a.getTime()-n.getTime();return s>0?Math.floor(s/6e4):0},hasSubmittedInCurrentPhase:()=>{const r=i();return r.submissionStatus?.letzte_einreichung!==void 0&&r.submissionStatus.letzte_einreichung.status==="freigegeben"},fetchActivePhase:async()=>{e({loading:!0,error:null});try{const r=await t.getActivePhase();e({activePhase:r,loading:!1})}catch(r){e({error:o(r),loading:!1})}},startNewPhase:async r=>{e({loading:!0,error:null});try{const a=await t.startPhase(r);e({activePhase:a.phase,loading:!1});const n=await t.getAllPhases();e({allPhases:n.phasen})}catch(a){throw e({error:o(a),loading:!1}),a}},closeCurrentPhase:async(r,a)=>{const n=i();if(!n.activePhase){e({error:"Keine aktive Phase zum Schließen"});return}e({loading:!0,error:null});try{const s=await t.closePhase(n.activePhase.id,{archiviere_entwuerfe:r,grund:a});e({activePhase:null,loading:!1});const l=await t.getAllPhases();e({allPhases:l.phasen}),c.info(`Phase geschlossen. ${s.archivierte_planungen} Planungen archiviert, ${s.geloeschte_entwuerfe} Entwürfe gelöscht.`)}catch(s){throw e({error:o(s),loading:!1}),s}},updatePhase:async(r,a)=>{e({loading:!0,error:null});try{const n=await t.updatePhase(r,a),s=i();s.activePhase?.id===r&&e({activePhase:n}),e({allPhases:s.allPhases.map(l=>l.id===r?n:l),loading:!1})}catch(n){throw e({error:o(n),loading:!1}),n}},checkSubmissionStatus:async r=>{e({loading:!0,error:null});try{const a=await t.checkSubmissionStatus(r);e({submissionStatus:a,loading:!1})}catch(a){e({error:o(a),loading:!1})}},recordNewSubmission:async r=>{e({loading:!0,error:null});try{const a=await t.recordSubmission(r);await i().checkSubmissionStatus();const n=i();e({phaseSubmissions:[...n.phaseSubmissions,a],loading:!1})}catch(a){throw e({error:o(a),loading:!1}),a}},fetchPhaseSubmissions:async r=>{e({loading:!0,error:null});try{const a=await t.getPhaseSubmissions(r);e({phaseSubmissions:a,loading:!1})}catch(a){e({error:o(a),loading:!1})}},fetchArchivedPlanungen:async r=>{e({loading:!0,error:null});try{const a=await t.getArchivedPlanungen(r);e({archivedPlanungen:a.planungen,loading:!1})}catch(a){e({error:o(a),loading:!1})}},restoreFromArchive:async r=>{e({loading:!0,error:null});try{const a=await t.restoreArchivedPlanung(r),n=i();return e({archivedPlanungen:n.archivedPlanungen.filter(s=>s.id!==r),loading:!1}),a.planung_id}catch(a){throw e({error:o(a),loading:!1}),a}},exportArchive:async r=>{e({loading:!0,error:null});try{const a=await t.exportArchiv(r),n=window.URL.createObjectURL(a),s=document.createElement("a");s.href=n,s.download=`archiv_export_${new Date().toISOString().split("T")[0]}.xlsx`,document.body.appendChild(s),s.click(),window.URL.revokeObjectURL(n),document.body.removeChild(s),e({loading:!1})}catch(a){e({error:o(a),loading:!1})}},fetchPhaseHistory:async r=>{e({loading:!0,error:null});try{const a=await t.getPhaseHistory(r);e({phaseHistory:a,loading:!1})}catch(a){e({error:o(a),loading:!1})}},fetchPhaseStatistics:async r=>{e({loading:!0,error:null});try{const a=await t.getPhaseStatistics(r);e({currentPhaseStatistics:a,loading:!1})}catch(a){e({error:o(a),loading:!1})}},generatePhaseReport:async r=>{e({loading:!0,error:null});try{const a=await t.generatePhaseReport(r),n=window.URL.createObjectURL(a),s=document.createElement("a");s.href=n,s.download=`phasenbericht_${r}_${new Date().toISOString().split("T")[0]}.pdf`,document.body.appendChild(s),s.click(),window.URL.revokeObjectURL(n),document.body.removeChild(s),e({loading:!1})}catch(a){e({error:o(a),loading:!1})}},sendRemindersToProfs:async(r,a)=>{e({loading:!0,error:null});try{const n=await t.sendReminders(r,a);c.info(`${n.gesendet} Erinnerungen gesendet, ${n.fehler} Fehler`),e({loading:!1})}catch(n){throw e({error:o(n),loading:!1}),n}},clearError:()=>e({error:null}),resetStore:()=>e(u)}),{name:"planung-phase-storage",partialize:e=>({activePhase:e.activePhase,submissionStatus:e.submissionStatus})}));export{w as u};
